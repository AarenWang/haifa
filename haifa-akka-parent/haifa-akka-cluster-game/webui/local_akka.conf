server {
    # 1. 监听 9558 端口
    listen 9558;
    server_name 127.0.0.1;

    location / {
        # 2. 检查是否为 OPTIONS 预检请求
        if ($request_method = 'OPTIONS') {
            # 如果是 OPTIONS 请求，则直接返回 204 (No Content)
            # 并添加所有需要的 CORS 头部

            # 允许所有来源 (为了安全，您也可以指定特定的域名)
            add_header 'Access-Control-Allow-Origin' '*';

            # 允许的 HTTP 方法
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH';

            # 允许所有请求头
            add_header 'Access-Control-Allow-Headers' '*';

            # 允许浏览器缓存此预检请求的结果，单位为秒
            add_header 'Access-Control-Max-Age' 1728000;

            # 响应正文为空
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;

            # 立即返回 204 响应，不转发给后端
            return 204;
        }

        # 3. 如果不是 OPTIONS 请求，则执行反向代理

        # 将请求转发到 8558 端口
        proxy_pass http://127.0.0.1:8558;

        # 传递标准的反向代理头部
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 4. 为非 OPTIONS 请求的响应也添加 CORS 头部
        # 这是必需的，浏览器在收到实际数据响应时也会检查此头部
        add_header 'Access-Control-Allow-Origin' '*' always;
    }
}